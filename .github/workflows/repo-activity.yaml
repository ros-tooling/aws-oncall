name: "Report repository activity"
on:
  pull_request:
  push:
    branches:
      - master
  schedule:
    - cron:  '0 * * * *'  # run every hour

jobs:
  repo_activity:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:bionic
    strategy:
      fail-fast: false
      matrix:
        # All ROS 2 repositories. Generated by the following command:
        # curl https://raw.githubusercontent.com/ros2/ros2/master/ros2.repos | sed -n -e 's/^  \(.*\):$/\1/gp' | sort | uniq
        repo:
        - ament/ament_cmake
        - ament/ament_index
        - ament/ament_lint
        - ament/ament_package
        - ament/googletest
        - ament/uncrustify_vendor
        - eProsima/Fast-CDR
        - eProsima/Fast-RTPS
        - eProsima/foonathan_memory_vendor
        - eclipse-cyclonedds/cyclonedds
        - osrf/osrf_pycommon
        - osrf/osrf_testing_tools_cpp
        - ros-perception/laser_geometry
        - ros-planning/navigation_msgs
        - ros-tooling/aws-oncall
        - ros-tooling/libstatistics_collector
        - ros-visualization/interactive_markers
        - ros-visualization/python_qt_binding
        - ros-visualization/qt_gui_core
        - ros-visualization/rqt
        - ros-visualization/rqt_action
        - ros-visualization/rqt_console
        - ros-visualization/rqt_graph
        - ros-visualization/rqt_msg
        - ros-visualization/rqt_plot
        - ros-visualization/rqt_publisher
        - ros-visualization/rqt_py_console
        - ros-visualization/rqt_reconfigure
        - ros-visualization/rqt_service_caller
        - ros-visualization/rqt_shell
        - ros-visualization/rqt_srv
        - ros-visualization/rqt_top
        - ros-visualization/rqt_topic
        - ros/class_loader
        - ros/pluginlib
        - ros/resource_retriever
        - ros/robot_state_publisher
        - ros/ros_environment
        - ros/ros_tutorials
        - ros/urdfdom_headers
        - ros2/ament_cmake_ros
        - ros2/common_interfaces
        - ros2/console_bridge_vendor
        - ros2/demos
        - ros2/eigen3_cmake_module
        - ros2/example_interfaces
        - ros2/examples
        - ros2/geometry2
        - ros2/kdl_parser
        - ros2/launch
        - ros2/launch_ros
        - ros2/libyaml_vendor
        - ros2/message_filters
        - ros2/orocos_kinematics_dynamics
        - ros2/python_cmake_module
        - ros2/rcl
        - ros2/rcl_interfaces
        - ros2/rcl_logging
        - ros2/rclcpp
        - ros2/rclpy
        - ros2/rcpputils
        - ros2/rcutils
        - ros2/realtime_support
        - ros2/rmw
        - ros2/rmw_connext
        - ros2/rmw_cyclonedds
        - ros2/rmw_dds_common
        - ros2/rmw_fastrtps
        - ros2/rmw_implementation
        - ros2/ros1_bridge
        - ros2/ros2cli
        - ros2/ros_testing
        - ros2/rosbag2
        - ros2/rosidl
        - ros2/rosidl_dds
        - ros2/rosidl_defaults
        - ros2/rosidl_python
        - ros2/rosidl_runtime_py
        - ros2/rosidl_typesupport
        - ros2/rosidl_typesupport_connext
        - ros2/rosidl_typesupport_fastrtps
        - ros2/rviz
        - ros2/spdlog_vendor
        - ros2/sros2
        - ros2/system_tests
        - ros2/test_interface_files
        - ros2/tinyxml2_vendor
        - ros2/tinyxml_vendor
        - ros2/tlsf
        - ros2/unique_identifier_msgs
        - ros2/urdf
        - ros2/urdfdom
        - ros2/yaml_cpp_vendor
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - uses: ros-tooling/action-repository-activity@0.0.1
      id: repo_activity
      with:
        repository: ${{ matrix.repo }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: open_issues_count
        metric-value: ${{ steps.repo_activity.outputs.open_issues_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: archived
        metric-value: ${{ steps.repo_activity.outputs.archived }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: disabled
        metric-value: ${{ steps.repo_activity.outputs.disabled }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: forks_count
        metric-value: ${{ steps.repo_activity.outputs.forks_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: network_count
        metric-value: ${{ steps.repo_activity.outputs.network_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: open_issues_count
        metric-value: ${{ steps.repo_activity.outputs.open_issues_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: stargazers_count
        metric-value: ${{ steps.repo_activity.outputs.stargazers_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: subscribers_count
        metric-value: ${{ steps.repo_activity.outputs.subscribers_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: watchers_count
        metric-value: ${{ steps.repo_activity.outputs.watchers_count }}
